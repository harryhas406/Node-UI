<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Title</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script src="https://code.highcharts.com/highcharts.js"></script> -->
    <style>
        /* For Chrome, Safari, and Edge */
        ::-webkit-scrollbar {
            width: 4px; /* Set the width of the scrollbar */
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #1e1e1e;  /* Track background */
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #888; /* Color of the scroll handle (thumb) */
            border-radius: 10px; /* Make the scroll handle rounded */
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555; /* Darker color when hovering over the scroll handle */
        }
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            --background-color: #1e1e1e;
            --text-color: #fff;
            --line-color: #fff;
            --button-background-color: #1669D3;
            --button-hover-color: #1669D3;
            --table-header-bg: #2C3E50;
            --table-row-bg: rgba(255, 255, 255, 0.1);
            --table-row-hover-bg: #333;
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            transition: background-color 0.5s ease, color 0.5s ease;
            scrollbar-width: thin; /* Makes the scrollbar thinner for firefox only */
            scrollbar-color: #888 #1e1e1e;
        }

        header {
            background-color: #313840;
            text-align: center;
            position: fixed;
            width: 100%;
            z-index: 1000;
            padding: 5px;
        }
        .logo {
            width: 35px;
            margin-right: 10px;
        }
        .line {
            width: 100%;
            height: 2px;
            background-color: var(--line-color);
            margin: 0;
        }

        .sidebar {
            background-color: #313840;
            color: #fff;
            width: 180px;
            position: fixed;
            top: 50px; /* Below header */
            bottom: 0;
            overflow-y: auto; /* Scrollable if needed */
            padding: 10px;
        }
        .sidebar.collapsed {
            width: 50px; /* Width when collapsed */
        }

        .sidebar a {
            display: block;
            color: #fff;
            padding: 10px;
            text-decoration: none;
            transition: opacity 0.3s; /* Smooth transition for link opacity */
        }

        .sidebar.collapsed a {
            opacity: 0; /* Hide links when collapsed */
            padding: 10px 0; /* Reduce padding */
        }

        .sidebar.collapsed a:hover {
            opacity: 0; /* Prevent hover effect when collapsed */
        }

        .sidebar a:hover {
            background-color: #555;
        }

        .content {
            display: flex;
            flex-wrap: wrap; /* Allow the items to wrap into multiple rows */
            justify-content: space-between;
            margin-left: 200px; /* Space for sidebar */
            margin-top: 50px; /* Space for header */
            padding: 20px;
            gap: 20px;
            overflow-y: auto; /* Makes the content scrollable */
            height: calc(100vh - 60px); /* Full height minus header */
            transition: margin-left 0.3s; /* Smooth transition for content */
        }
        .content.collapsed {
            margin-left: 70px; /* Adjust for collapsed sidebar */
        }

        .column {
            width: 47.97%; /* Full width for the main column */
            padding: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            height: auto; /* Height adjusts based on content */
            background-color: #313840; /* Add background color */
            display: flex; /* Enable flexbox */
            flex-direction: column; /* Align items vertically */
        }

        .full-column {
            flex-direction: column; /* Stack the links and chart vertically */
        }

        .links-chart-wrapper {
            display: flex; /* Enable flexbox for links and chart */
            justify-content: space-between; /* Space between links and chart */
            align-items: flex-start; /* Align items to the top */
            width: 100%; /* Full width for the wrapper */
        }

        .links-column {
            width: 20%; /* Adjust width for links */
            padding: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            background-color: #313840; /* Dark background */
            height: 400px; /* Fixed height for links column */
            overflow-y: auto; /* Enable vertical scroll for folder links */
        }

        .chart-column {
            width: 75%; /* Adjust width for chart */
            padding: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            background-color: #313840; /* Dark background */
            height: 400px; /* Fixed height for chart column */
        }

        h5 {
            color: #ffcc00; /* Title color */
            text-align: center; /* Center the title */
            margin-bottom: 10px;
            margin-top: 0;
        }
        a {
            color: #689fc4;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
        .toggle-button {
            background-color: #333;
            color: #fff;
            border: none;
            cursor: pointer;
            padding: 10px;
            position: absolute;
            bottom: 10px; /* Position at the bottom of the sidebar */
            left: 10px;
            z-index: 1001; /* Above sidebar */
        }
    </style>
    <script>
        function validateForm(event) {
            const input = document.querySelector('input[name="input_string"]');
            const errorMessage = document.getElementById('error-message');
            
            if (input.value.trim() === "") {
                event.preventDefault();
                errorMessage.style.display = 'block';
            } else {
                errorMessage.style.display = 'none';
            }
        }

        // Donut Chart using canvasjs for Social Media
        async function fetchChartData() {
            try {
                const response = await fetch('/pie-chart-data'); // Adjust the route as needed
                const data = await response.json();

                if (Array.isArray(data) && data.length > 0) {
                    const dataPoints = data.map(bucket => ({
                        y: bucket.doc_count,
                        name: bucket.key
                    }));

                    // Create the CanvasJS donut chart
                    var chart = new CanvasJS.Chart("socialMediaChartContainer", {
                        exportEnabled: true,
                        animationEnabled: true,
                        backgroundColor: "transparent", // Set background color to transparent
                        legend: {
                            cursor: "pointer",
                            itemclick: explodePie,
                            fontColor: "#fff", // Set legend text color to white
                            fontSize: 11
                        },
                        data: [{
                            type: "doughnut",
                            showInLegend: true,
                            toolTipContent: "<span style='color: #ff5733'>{name}</span>: <strong>{y}%</strong>",
                            indexLabel: "{name} - {y}",
                            indexLabelFontColor: "#fff",  // Set index label color to white
                            innerRadius: "60%", // Set inner radius for donut effect
                            dataPoints: dataPoints
                        }],
                        // credits: {
                        //     enabled: false  // Disable the watermark
                        // }
                    });
                    chart.render();
                } else {
                    document.getElementById('socialMediaChartContainer').innerHTML = 'No data to display';
                }
            } catch (error) {
                console.error('Error fetching chart data:', error);
            }
        }

        // Explode pie slice on click
        function explodePie(e) {
            if (typeof (e.dataSeries.dataPoints[e.dataPointIndex].exploded) === "undefined" || !e.dataSeries.dataPoints[e.dataPointIndex].exploded) {
                e.dataSeries.dataPoints[e.dataPointIndex].exploded = true;
            } else {
                e.dataSeries.dataPoints[e.dataPointIndex].exploded = false;
            }
            e.chart.render();
        }

        // Donut chart for Darkweb files, display using Canvasjs
        async function fetchFolderCountData() {
            try {
                const response = await fetch('/folder-count');  // Fetch the folder counts
                const data = await response.json();

                // Log the response for debugging
                console.log('Fetched Data:', data);

                if (Object.keys(data).length > 0) {
                    const dataPoints = Object.keys(data).map(folder => ({
                        y: data[folder],  // File counts as values
                        name: folder      // Folder names as labels
                    }));

                    console.log('Data Points:', dataPoints);

                    // Create the CanvasJS pie chart
                    var chart = new CanvasJS.Chart("darkwebFolderChart", {
                        exportEnabled: true,
                        animationEnabled: true,
                        backgroundColor: "transparent",  // Transparent background
                        legend: {
                            cursor: "pointer",
                            itemclick: explodePie,
                            fontColor: "#fff", // Set legend text color to white
                            fontSize: 11
                        },
                        data: [{
                            type: "doughnut",
                            showInLegend: true,
                            toolTipContent: "{name}: <strong>{y}</strong>",
                            indexLabel: "{name} - {y}",  // Folder name and file count
                            indexLabelFontColor: "#fff",  // White text for labels
                            dataPoints: dataPoints
                        }],
                        credits: {
                            enabled: false  // Disable the watermark
                        }
                    });

                    // Display folder names as clickable links
                    let folderLinks = '';
                    dataPoints.forEach(folder => {
                        folderLinks += `<li><a href="/files-page?folderName=${encodeURIComponent(folder.name)}">${folder.name}</a></li>`;
                    });
                    document.getElementById('folder-links').innerHTML = `<ul>${folderLinks}</ul>`;
                    // Render the chart
                    chart.render();
                } else {
                    document.getElementById('darkwebFolderChart').innerHTML = 'No data to display';
                }
            } catch (error) {
                console.error('Error fetching folder count data:', error);
                document.getElementById('darkwebFolderChart').innerHTML = 'Error loading data';
            }
        }

        async function fetchFiles(folderName) {
            try {
                const response = await fetch(`/files/${folderName}`); // Fetch files from the specified folder
                const files = await response.json();

                // Log the response for debugging
                console.log('Fetched Files:', files);

                if (files.length > 0) {
                    let fileLinks = '';
                    files.forEach(file => {
                        fileLinks += `<li><a href="/fetch/${encodeURIComponent(file)}" target="_blank">${file}</a></li>`;
                    });
                    document.getElementById('file-list').innerHTML = `<ul>${fileLinks}</ul>`; // Display the files
                } else {
                    document.getElementById('file-list').innerHTML = 'No files found in this folder.'; // Handle no files case
                }
            } catch (error) {
                console.error('Error fetching files:', error);
                document.getElementById('file-list').innerHTML = 'Error loading files.'; // Handle fetch error
            }
        }

        //Ashish
        // Bar Graph for displaying phishing data using Canvasjs
        async function displayPhishingData() {
            try {
                // Fetch the phishing data from the backend
                const response = await fetch("/get_phishing_data");
                const phishingData = await response.json();

                // Process the phishing data into dataPoints for the chart
                const dataPoints = phishingData.map(item => ({
                    y: item.entries,
                    label: item.domain  // Use the domain from the file name as the label
                }));

                // Create the chart
                var chart = new CanvasJS.Chart("phishingDataChart", {
                    exportEnabled: true,
                    animationEnabled: true,
                    backgroundColor: "transparent",
                    legend: {
                        cursor: "pointer",
                        itemclick: explodePie,
                        fontColor: "#fff",
                        fontSize: 10
                    },
                    axisY: {
                        title: "Phishing Entries",
                        fontColor: "#fff",
                        labelFontColor: "#fff"
                    },
                    axisX: {
                        title: "Domain",
                        fontColor: "#fff",
                        labelFontColor: "#fff",
                        interval: 1, // Force every label to display
                        labelAngle: 15, // Rotate labels to avoid overlapping
                    },
                    data: [{
                        type: "column",
                        showInLegend: true,
                        legendMarkerColor: "#fff",
                        legendText: "Domain",
                        dataPoints: dataPoints
                    }]
                });

                chart.render();

                // Add hover effect to enhance visibility
                const bars = document.querySelectorAll(".canvasjs-chart-canvas rect");
                bars.forEach(bar => {
                    bar.addEventListener("mouseover", () => {
                            bar.style.fill = "#FFD700";  // Gold color on hover
                        });
                        bar.addEventListener("mouseout", () => {
                            bar.style.fill = "#4CAF50";  // Original color
                        });
                    });


            } catch (error) {
                console.error("Error fetching phishing data:", error);
            }
        }

        // Combine both functions under a single window.onload event
        window.onload = async function() {
            // loadFiles();  // Load MinIO files
            // loadIndiaRelatedAlerts();  // Load India-related alerts
            fetchChartData();  // Load Pie Chart data Fr
            fetchFolderCountData(); // Load Darkweb files as Chart
            displayPhishingData(); // Display Phishing Data as Chart
            // fetchFiles();
        };
    </script>
</head>
<body>

    <header>
        <a href="/"><img class="logo" src="/CDOT_logo.jpg" alt="Logo"></a>
        <div class="line"></div>
    </header>

    <div class="sidebar">
        <h2>Navigation</h2>
        <a href="/drkweb">DarkWeb</a>
        <a href="/telegram">Hactivist_Terrorism</a>
        <a href="/ransomware">RansomWare</a>
        <a href="/phishing">Phishing</a>
        
        <button class="toggle-button" onclick="toggleSidebar()">â˜°</button> <!-- Moved button here -->
    </div>

    <div class="content">
        <!-- Box 1 -->
        <div class="column full-column">
            <h5>DARKWEB FILES</h5>
            <div class="links-chart-wrapper">
                <div class="links-column">
                    <div id="folder-links" style="text-align: left;">
                        <!-- Folder links will be inserted here by fetchFolderCountData() -->
                    </div>
                    <div id="file-list">
                        <!-- Files will be displayed here when a folder is clicked -->
                    </div>
                </div>

                <div class="chart-column">
                    <div id="darkwebFolderChart" style="height: 400px; background: transparent;">
                        <!-- Pie chart will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Box 2 -->
        <div class="column">
            <h5>SOCIAL MEDIA</h5>
            <div id="socialMediaChartContainer" style="height: 400px; width: 100%; background: transparent;"></div> <!-- Chart will render here -->
        </div>

        <!-- Box 3 -->
        <div class="column">
            <h5>RANSOM STATS OF MONTH</h5>
            <!-- Embedding monthgraph.html in this box -->
            <iframe src="/bar_chart_last_7_days.html" style="width:100%; height:350px; border:none;"></iframe>
        </div>
        
        <!-- Box 4 -->
        <div class="column">
            <h5>PHISHING</h5>
            <div id="phishingDataChart" style="width: 100%; height: 370px; background: transparent;"></div>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
    
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
    
            // Adjust the margin of the content based on the sidebar's state
            if (sidebar.classList.contains('collapsed')) {
                content.style.marginLeft = '70px'; // Adjust for collapsed sidebar
            } else {
                content.style.marginLeft = '220px'; // Adjust for expanded sidebar
            }
        }
    </script>

</body>
</html>
